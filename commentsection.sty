\ProvidesPackage{threadedcomments}[2024/08/20 v1.0 Threaded comments with automatic comment handling]

\newcounter{threaddepth} % Counter for the depth

% Increment the depth
\newcommand{\step}{
    \stepcounter{threaddepth}
}

% Decrement the depth
\newcommand{\unstep}{
    \addtocounter{threaddepth}{-1}
}

% Draw vertical lines for the current depth
\newcommand{\drawlines}{
    \ifnum\value{threaddepth}>0
        \makebox[0pt][r]{%
            \vbox{
                \hrule height 0pt
                \hbox{\advance\hsize by -\value{threaddepth}em}%
                \hbox{\rule[-1.5em]{0.4pt}{1.5em}}
                \ifnum\value{threaddepth}>1
                    \hbox{\rule[-1.5em]{0.4pt}{1.5em}}
                \fi
                \ifnum\value{threaddepth}>2
                    \hbox{\rule[-1.5em]{0.4pt}{1.5em}}
                \fi
            }
        }\hspace{0.5em}
    \fi
}

% Environment for each individual comment
\newenvironment{comment}{
    \item[]\drawlines\makebox[\value{threaddepth}em][l]{%
        \ifnum\value{threaddepth}>0 \rule{0.4pt}{1.5em} \fi \hspace{0.5em}}%
        \begin{minipage}[t]{\dimexpr\linewidth-\value{threaddepth}em-0.5em\relax}
}{
        \end{minipage}\vspace{0.5em}
}

% Start the environment for the comment thread
\newenvironment{threadedcomment}{
    \setcounter{threaddepth}{0} % Start with depth 0
    \begin{list}{}{
        \setlength{\leftmargin}{0pt} % No initial left margin
        \setlength{\itemindent}{0pt} % No initial item indent
        \setlength{\itemsep}{0pt} % No extra space between items
    }
}{
    \end{list}
}
\endinput
